<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .heartbeat-dot {
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background-color: red;
            display: inline-block;
            opacity: 0.4;
            transition: opacity 0.3s ease;
        }
        .heartbeat-active {
            opacity: 1;
        }
    </style>
    <script>
        function toggleDurationField() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const durationField = document.getElementById("durationField");
            durationField.style.display = (mode === "timed") ? "block" : "none";
        }

        function updateHeartbeats() {
            fetch("/heartbeat_data")
                .then(response => response.json())
                .then(data => {
                    let totalUsed = 0;
                    let totalCpu = 0;

                    data.forEach(node => {
                        const dot = document.getElementById(`heartbeat-dot-${node.id}`);
                        const countEl = document.getElementById(`heartbeat-count-${node.id}`);
                        const timeEl = document.getElementById(`heartbeat-time-${node.id}`);

                        if (node.spike && dot) {
                            dot.classList.add("heartbeat-active");
                            setTimeout(() => {
                                dot.classList.remove("heartbeat-active");
                            }, 300);
                        }

                        if (countEl) countEl.textContent = node.heartbeat_count;
                        if (timeEl) timeEl.textContent = node.last_heartbeat;

                        totalUsed += node.used_cpu;
                        totalCpu += node.cpu_cores;
                    });

                    const percent = totalCpu > 0 ? Math.floor((totalUsed / totalCpu) * 100) : 0;
                    const bar = document.getElementById('cpuUsageBar');
                    if (bar) {
                        bar.style.width = percent + '%';
                        bar.textContent = `${totalUsed} / ${totalCpu} CPU (${percent}%)`;

                        // Remove existing color classes
                        bar.classList.remove('bg-success', 'bg-warning', 'bg-danger');

                        // Apply color based on usage
                        if (percent < 60) {
                                bar.classList.add('bg-success');
                        } else if (percent < 80) {
                                bar.classList.add('bg-warning');
                        } else {
                                bar.classList.add('bg-danger');
                        }
                    }
                });
        }

        setInterval(updateHeartbeats, 5000);
        window.onload = updateHeartbeats;
    </script>
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center">Node Manager</h2>

        <!-- CPU Usage Progress Bar -->
        <div class="mb-4">
            <h5>Cluster CPU Usage</h5>
            <div class="progress">
                <div id="cpuUsageBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
        </div>

        <!-- Add Node Form -->
        <form method="POST" action="/add_node" class="mb-4">
            <div class="input-group">
                <input type="number" name="cpu_cores" class="form-control" placeholder="CPU Cores" required>
                <button type="submit" class="btn btn-success">Add Node</button>
            </div>
        </form>

        <!-- Launch Pod Form -->
        <form method="POST" action="/launch_pod" class="mb-4">
            <div class="card p-3">
                <h5>Launch Pod</h5>
                <div class="row mb-2">
                    <div class="col">
                        <input type="number" name="cpu" class="form-control" placeholder="CPU Required" required>
                    </div>
                    <div class="col">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="mode" value="infinite" checked onchange="toggleDurationField()">
                            <label class="form-check-label">Infinite</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="mode" value="timed" onchange="toggleDurationField()">
                            <label class="form-check-label">Timed</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2" id="durationField" style="display: none;">
                    <div class="col">
                        <input type="number" name="duration" class="form-control" placeholder="Duration (in seconds)">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Launch Pod</button>
            </div>
        </form>

        <!-- Node List Table -->
        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Node ID</th>
                    <th>CPU (Used / Total)</th>
                    <th>Status</th>
                    <th>Container ID</th>
                    <th>Heartbeat</th>
                    <th>Pods</th>
                </tr>
            </thead>
            <tbody>
                {% for node in nodes %}
                <tr>
                    <td>{{ node.id }}</td>
                    <td>{{ node.used_cpu }} / {{ node.cpu_cores }}</td>
                    <td>{{ node.status }}</td>
                    <td>{{ node.container_id }}</td>
                    <td>
                        <div>
                            <span id="heartbeat-dot-{{ node.id }}" class="heartbeat-dot"></span>
                        </div>
                        <div>
                            Count: <span id="heartbeat-count-{{ node.id }}">0</span>
                        </div>
                        <div style="font-size: small;">
                            Last: <span id="heartbeat-time-{{ node.id }}">-</span>
                        </div>
                    </td>
                    <td>
                        {% for pod in node.pods %}
                            <div><strong>{{ pod.id }}</strong> ({{ pod.mode }}, {{ pod.cpu }} CPU)</div>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>
